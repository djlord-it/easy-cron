name: HA Test

on:
  push:
    branches: [main]
  pull_request:

jobs:
  ha-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Ensure scripts are executable
        run: chmod +x scripts/ha_test.sh

      - name: Run HA test harness
        run: ./scripts/ha_test.sh

      - name: Collect diagnostics
        if: failure()
        run: |
          mkdir -p ha_artifacts

          docker compose -f docker-compose.ha-test.yml -p easycron-ha-test ps \
            > ha_artifacts/compose_ps.txt 2>&1 || true

          docker compose -f docker-compose.ha-test.yml -p easycron-ha-test logs --no-color \
            > ha_artifacts/compose.log 2>&1 || true

          for svc in easycron_1 easycron_2 easycron_3 postgres webhook-receiver; do
            docker compose -f docker-compose.ha-test.yml -p easycron-ha-test logs --no-color "$svc" \
              > "ha_artifacts/${svc}.log" 2>&1 || true
          done

          curl -sf http://localhost:9090/stats \
            > ha_artifacts/receiver_stats.json 2>/dev/null || true

      - name: Upload artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ha-artifacts
          path: ha_artifacts/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.ha-test.yml -p easycron-ha-test down -v --remove-orphans 2>/dev/null || true
